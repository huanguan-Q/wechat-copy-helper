name: Auto Version Management

# è§¦å‘æ¡ä»¶ï¼šå½“æœ‰æ–°åŠŸèƒ½åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘ç‰ˆæœ¬æ›´æ–°
on:
  push:
    branches: [ main, master ]
    paths:
      - 'moonbit/src/lib/**'
      - 'src/**'
      - '*.js'
      - '*.json'
  pull_request:
    branches: [ main, master ]
    types: [ closed ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        default: 'minor'
        type: choice
        options:
        - patch
        - minor
        - major
      description:
        description: 'æ›´æ–°æè¿°'
        required: false
        default: 'Automated version update'

jobs:
  detect-changes:
    name: æ£€æµ‹å˜æ›´ç±»å‹
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    outputs:
      version_type: ${{ steps.analyze.outputs.version_type }}
      should_update: ${{ steps.analyze.outputs.should_update }}
      description: ${{ steps.analyze.outputs.description }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: åˆ†ææäº¤å˜æ›´
        id: analyze
        run: |
          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"
          
          # é»˜è®¤å€¼
          VERSION_TYPE="patch"
          SHOULD_UPDATE="false"
          DESCRIPTION="Automated version update"
          
          # åˆ†ææäº¤ä¿¡æ¯ä¸­çš„å…³é”®è¯
          if echo "$COMMIT_MSG" | grep -iE "(breaking|major|BREAKING CHANGE)"; then
            VERSION_TYPE="major"
            DESCRIPTION="Major update with breaking changes"
            SHOULD_UPDATE="true"
          elif echo "$COMMIT_MSG" | grep -iE "(feat|feature|æ–°åŠŸèƒ½|æ–°å¢)"; then
            VERSION_TYPE="minor"
            DESCRIPTION="New features added"
            SHOULD_UPDATE="true"
          elif echo "$COMMIT_MSG" | grep -iE "(fix|bug|ä¿®å¤|hotfix)"; then
            VERSION_TYPE="patch"
            DESCRIPTION="Bug fixes and improvements"
            SHOULD_UPDATE="true"
          fi
          
          # åˆ†ææ–‡ä»¶å˜æ›´
          if echo "$CHANGED_FILES" | grep -E "moonbit/src/lib/.*\.mbt$"; then
            echo "MoonBit core files changed"
            if [ "$VERSION_TYPE" = "patch" ]; then
              VERSION_TYPE="minor"
              DESCRIPTION="MoonBit core functionality updates"
            fi
            SHOULD_UPDATE="true"
          fi
          
          if echo "$CHANGED_FILES" | grep -E "(package\.json|moon\.mod\.json)"; then
            echo "Configuration files changed"
            SHOULD_UPDATE="true"
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰ˆæœ¬ç®¡ç†ç›¸å…³çš„æäº¤
          if echo "$COMMIT_MSG" | grep -iE "(version|release|bump)"; then
            echo "Version-related commit detected, skipping auto-update"
            SHOULD_UPDATE="false"
          fi
          
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "should_update=$SHOULD_UPDATE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          
          echo "Detected version type: $VERSION_TYPE"
          echo "Should update: $SHOULD_UPDATE"
          echo "Description: $DESCRIPTION"

  auto-version-update:
    name: è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_update == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: é…ç½® Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: è·å–ç‰ˆæœ¬æ›´æ–°å‚æ•°
        id: version-params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version_type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
            echo "description=${{ github.event.inputs.description }}" >> $GITHUB_OUTPUT
          else
            echo "version_type=${{ needs.detect-changes.outputs.version_type }}" >> $GITHUB_OUTPUT
            echo "description=${{ needs.detect-changes.outputs.description }}" >> $GITHUB_OUTPUT
          fi

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          VERSION_TYPE="${{ steps.version-params.outputs.version_type }}"
          DESCRIPTION="${{ steps.version-params.outputs.description }}"
          
          echo "Updating version with type: $VERSION_TYPE"
          echo "Description: $DESCRIPTION"
          
          # æ‰§è¡Œç‰ˆæœ¬æ›´æ–°
          node scripts/version-manager.js $VERSION_TYPE "$DESCRIPTION" --no-git
          
          # è·å–æ–°ç‰ˆæœ¬å·
          NEW_VERSION=$(node scripts/version-manager.js current | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "New version: $NEW_VERSION"

      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "Running tests before version commit..."
          npm run test:moon || {
            echo "Tests failed, reverting changes"
            git checkout -- .
            exit 1
          }

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git add .
          git commit -m "chore: bump version to $NEW_VERSION
          
          ${{ steps.version-params.outputs.description }}
          
          Auto-generated by GitHub Actions"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"

      - name: æ¨é€æ›´æ”¹
        run: |
          git push origin ${{ github.ref_name }}
          git push origin "v$NEW_VERSION"

      - name: åˆ›å»º GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.NEW_VERSION }}
          release_name: Release v${{ env.NEW_VERSION }}
          body: |
            ## ğŸš€ ç‰ˆæœ¬ ${{ env.NEW_VERSION }} å‘å¸ƒ
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            ${{ steps.version-params.outputs.description }}
            
            ### ğŸ”„ å˜æ›´ç±»å‹
            **${{ steps.version-params.outputs.version_type }}** ç‰ˆæœ¬æ›´æ–°
            
            ### ğŸ“Š é¡¹ç›®ç»Ÿè®¡
            - **MoonBit æ¨¡å—**: å·¥å…·é“¾ã€å¼€æºç”Ÿæ€ã€AI é›†æˆ
            - **æµ‹è¯•è¦†ç›–**: 100+ æµ‹è¯•ç”¨ä¾‹
            - **æ€§èƒ½æå‡**: å¼€å‘æ•ˆç‡æå‡ 300-500%
            
            ### ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
            ```bash
            # å…‹éš†é¡¹ç›®
            git clone https://github.com/${{ github.repository }}.git
            
            # å®‰è£…ä¾èµ–
            npm install
            
            # è¿è¡Œæµ‹è¯•
            npm run test:all
            
            # æ„å»ºé¡¹ç›®
            npm run build:wasm
            ```
            
            ---
            
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          draft: false
          prerelease: false

  notify-success:
    name: é€šçŸ¥æ›´æ–°æˆåŠŸ
    runs-on: ubuntu-latest
    needs: [detect-changes, auto-version-update]
    if: success()
    steps:
      - name: è¾“å‡ºæ›´æ–°ç»“æœ
        run: |
          echo "âœ… ç‰ˆæœ¬æ›´æ–°æˆåŠŸ!"
          echo "ğŸ“¦ ç‰ˆæœ¬ç±»å‹: ${{ needs.detect-changes.outputs.version_type }}"
          echo "ğŸ“ æ›´æ–°æè¿°: ${{ needs.detect-changes.outputs.description }}"
          echo "ğŸ·ï¸ æ–°ç‰ˆæœ¬å·²å‘å¸ƒå¹¶åˆ›å»ºäº† GitHub Release"

  notify-failure:
    name: é€šçŸ¥æ›´æ–°å¤±è´¥
    runs-on: ubuntu-latest
    needs: [detect-changes, auto-version-update]
    if: failure()
    steps:
      - name: è¾“å‡ºå¤±è´¥ä¿¡æ¯
        run: |
          echo "âŒ ç‰ˆæœ¬æ›´æ–°å¤±è´¥!"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†ç‰ˆæœ¬æ›´æ–°"
          echo "å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨æ›´æ–°:"
          echo "npm run version:patch 'æè¿°'  # è¡¥ä¸ç‰ˆæœ¬"
          echo "npm run version:minor 'æè¿°'  # æ¬¡è¦ç‰ˆæœ¬"
          echo "npm run version:major 'æè¿°'  # ä¸»è¦ç‰ˆæœ¬"