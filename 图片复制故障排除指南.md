# 图片复制故障排除指南

## 🚨 问题现状
图片仍然无法复制到Pages文稿，需要深入诊断和解决。

## 🔍 可能的根本原因

### 1. **浏览器剪贴板权限问题**
- Chrome可能没有授予剪贴板访问权限
- 安全策略阻止了剪贴板API

### 2. **图片跨域问题**
- 微信图片服务器的CORS策略过于严格
- referrer策略不正确

### 3. **图片格式兼容性**
- Pages对某些图片格式支持不好
- 透明背景图片显示问题

### 4. **Canvas污染问题**
- 跨域图片污染了Canvas
- 无法从污染的Canvas提取数据

## 🧪 使用调试版本进行诊断

### 步骤1：安装调试版本
```bash
# 备份当前版本
cp manifest.json manifest-backup.json

# 使用调试版本
cp manifest-debug.json manifest.json
```

### 步骤2：重新加载扩展
1. 打开 `chrome://extensions/`
2. 找到"微信文档归档助手"
3. 点击"重新加载"按钮
4. 确认名称变为"微信文档归档助手 - 调试版"

### 步骤3：测试诊断
1. **打开微信公众号文章**
2. **查看调试控制面板**（左下角黑色面板）
3. **点击"测试剪贴板"**按钮
4. **查看浏览器控制台**（F12）

## 🔧 详细诊断步骤

### 检查1：剪贴板API支持
```javascript
// 在控制台运行
console.log('Clipboard API支持:', {
    clipboard: !!navigator.clipboard,
    write: !!(navigator.clipboard && navigator.clipboard.write),
    ClipboardItem: !!window.ClipboardItem
});
```

**预期结果**：所有项都应该是 `true`

### 检查2：权限状态
```javascript
// 检查剪贴板权限
navigator.permissions.query({name: 'clipboard-write'}).then(result => {
    console.log('剪贴板写入权限:', result.state);
});
```

**预期结果**：应该是 `"granted"` 或 `"prompt"`

### 检查3：手动测试复制
```javascript
// 手动测试文本复制
navigator.clipboard.writeText('测试文本').then(() => {
    console.log('✅ 文本复制成功');
}).catch(err => {
    console.error('❌ 文本复制失败:', err);
});
```

### 检查4：图片复制测试
1. 悬停任意图片
2. 点击"🧪 测试"按钮
3. 查看控制台输出的图片信息
4. 点击"📋 复制"按钮
5. 观察详细的错误信息

## 🛠️ 常见问题解决方案

### 问题1：剪贴板权限被拒绝
**症状**：控制台显示 "NotAllowedError" 或权限状态为 "denied"

**解决方案**：
1. 点击地址栏左侧的锁图标
2. 确保"剪贴板"权限设置为"允许"
3. 刷新页面重试

### 问题2：Canvas被污染
**症状**：控制台显示 "SecurityError" 或 "canvas has been tainted"

**解决方案**：
```javascript
// 在调试版本中会自动尝试不同的方法
// 包括fetch方式和代理方式
```

### 问题3：图片格式不兼容
**症状**：复制成功但粘贴到Pages显示异常

**解决方案**：
- 调试版本会自动添加白色背景
- 统一转换为PNG格式
- 使用高质量参数

### 问题4：网络请求失败
**症状**：控制台显示网络错误或CORS错误

**解决方案**：
1. 检查网络连接
2. 尝试刷新页面
3. 使用VPN（如果在特殊网络环境）

## 🔍 深度诊断命令

### 在控制台运行以下命令进行深度诊断：

```javascript
// 1. 检查页面环境
console.log('页面信息:', {
    url: location.href,
    domain: location.hostname,
    protocol: location.protocol,
    userAgent: navigator.userAgent
});

// 2. 检查图片状态
document.querySelectorAll('img').forEach((img, i) => {
    console.log(`图片${i+1}:`, {
        src: img.src,
        complete: img.complete,
        naturalWidth: img.naturalWidth,
        naturalHeight: img.naturalHeight,
        crossOrigin: img.crossOrigin,
        referrerPolicy: img.referrerPolicy
    });
});

// 3. 测试Canvas功能
const testCanvas = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 100;
    canvas.height = 100;
    ctx.fillStyle = 'red';
    ctx.fillRect(0, 0, 100, 100);
    
    try {
        const dataUrl = canvas.toDataURL();
        console.log('✅ Canvas功能正常');
        return true;
    } catch (error) {
        console.error('❌ Canvas功能异常:', error);
        return false;
    }
};
testCanvas();

// 4. 测试Blob创建
canvas.toBlob((blob) => {
    if (blob) {
        console.log('✅ Blob创建成功，大小:', blob.size);
    } else {
        console.error('❌ Blob创建失败');
    }
}, 'image/png');
```

## 📋 手动复制方案

如果自动复制仍然失败，可以使用以下手动方案：

### 方案1：右键保存
1. 右键点击图片
2. 选择"图片另存为"
3. 保存为PNG格式
4. 在Pages中插入图片文件

### 方案2：截图工具
1. 使用系统截图工具（Cmd+Shift+4）
2. 截取图片区域
3. 直接粘贴到Pages

### 方案3：拖拽方式
1. 直接拖拽图片到Pages
2. 或拖拽到桌面后再插入

## 🔄 回滚到原版本

如果调试版本有问题，可以快速回滚：

```bash
cp manifest-backup.json manifest.json
```

然后重新加载扩展。

## 📞 获取技术支持

如果问题仍然存在，请提供以下信息：

1. **浏览器信息**
   ```javascript
   console.log(navigator.userAgent);
   ```

2. **剪贴板支持检查结果**
3. **控制台的完整错误信息**
4. **具体的测试文章链接**
5. **操作系统版本**（macOS版本）
6. **Pages版本**

## 🎯 预期结果

使用调试版本后，你应该能看到：
- 左下角的调试控制面板
- 每张图片上的"📋 复制"和"🧪 测试"按钮
- 右上角的详细状态消息
- 控制台中的详细日志信息

这些信息将帮助我们准确定位问题所在并提供针对性的解决方案。